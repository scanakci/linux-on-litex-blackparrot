name: ci

on: [push, pull_request]

jobs:
  build:
    runs-on: ubuntu-20.04
    steps:
      # Checkout Repository
      - name: Checkout
        uses: actions/checkout@v2

      # Install Tools
      - name: Install Tools
        run: |
          sudo apt-get install wget build-essential python3 libevent-dev libjson-c-dev device-tree-compiler flex libfl-dev
          pip3 install setuptools
          pip3 install requests
          pip3 install pexpect
      # Install (n)Migen / LiteX / Cores
      - name: Install LiteX
        run: |
          git clone --branch ulx3s https://github.com/black-parrot-hdk/litex
          cd litex
          git checkout 9bfd7d94
          python3 litex_setup.py init install --user
      # Install RISC-V GCC
      - name: Install RISC-V GCC
        run: |
          wget https://raw.githubusercontent.com/enjoy-digital/litex/master/litex_setup.py
          python3 litex_setup.py gcc
          sudo mkdir /usr/local/riscv
          sudo cp -r $PWD/../riscv64-*/* /usr/local/riscv
      # Modify, Build and Install Verilator
      - name: Install Verilator
        run: |
          git clone https://github.com/verilator/verilator.git
          cd verilator
          sed -i 's/LINE_TOKEN_MAX = 40000/LINE_TOKEN_MAX = 1000000/' src/V3PreProc.h
          autoconf
          ./configure
          make -j2
          sudo make install
      # Test
      - name: Run Tests
        run: |
          export PATH=/usr/local/riscv/bin:$PATH
          sed -i 's/soc\.add_constant("ROM_BOOT_ADDRESS", 0x40000000)/soc\.add_constant("ROM_BOOT_ADDRESS", 0x80000000)/' litex/litex/tools/litex_sim.py
          pushd .
          cd  litex/litex/soc/cores/cpu/blackparrot
          source ./setEnvironment.sh
          popd
          litex_sim --cpu-type blackparrot \
            --cpu-variant standard \
            --output-dir $PWD/build/BP_linux_simu/ \
            --ram-init prebuilt/simulation/Genesys2/boot.bin.uart.simu \
            --threads 2 \
            | sed '/Welcome to Buildroot/q; /Traceback (most recent call last):/q1'