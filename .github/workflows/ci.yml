name: ci

on: [push, pull_request]

jobs:
  build:
    runs-on: ubuntu-20.04
    steps:
      # Checkout Repository
      - name: Checkout
        uses: actions/checkout@v2

      # Install Tools
      - name: Install Tools
        run: |
          sudo apt-get install wget build-essential python3 verilator libevent-dev libjson-c-dev device-tree-compiler
          pip3 install setuptools
          pip3 install requests
          pip3 install pexpect
      # Install (n)Migen / LiteX / Cores
      - name: Install LiteX
        run: |
          git clone --branch working_linux https://github.com/black-parrot-hdk/litex
          cd litex
          python3 litex_setup.py init install --user
          ./apply_patches.sh
      # Install RISC-V GCC
      - name: Install RISC-V GCC
        run: |
          wget https://raw.githubusercontent.com/enjoy-digital/litex/master/litex_setup.py
          python3 litex_setup.py gcc
          sudo mkdir /usr/local/riscv
          sudo cp -r $PWD/../riscv64-*/* /usr/local/riscv
      # Test
      - name: Run Tests
        run: |
          export PATH=/usr/local/riscv/bin:$PATH
          sed -i 's/soc\.add_constant\("ROM_BOOT_ADDRESS", 0x40000000\)/soc\.add_constant\("ROM_BOOT_ADDRESS", 0x80000000\)/' litex/litex/tools/litex_sim.py
          source litex/litex/soc/cores/cpu/blackparrot/setEnvironment.sh
          litex_sim --cpu-type blackparrot --cpu-variant standard --output-dir $PWD/build/BP_linux_simu/ --ram-init prebuilt/simulation/Genesys2/boot.bin.uart.simu